\documentclass[a4paper,12pt]{refrep}
\title{Developer Manual}

% Set the page title
\newcommand{\mycontent}[0]{
\begin{tabular}{l}
\hspace*{-4cm} \em XCSoar Developer Manual \vspace*{2pt}
\end{tabular}}

\input{../xcsoar.sty}
\input{title-xcsoar.sty}

\usepackage{tikz}
\usetikzlibrary{arrows,shapes,fit,decorations,decorations.pathmorphing,decorations.pathreplacing,calc}

\tikzstyle{thread}=[draw, fill=lightgray, text centered,
  minimum width=7em, minimum height=2.5em]

\begin{document}
\maketitle

\begingroup
\setlength{\parskip}{0.1\baselineskip}
\tableofcontents
\endgroup

%%%%%%%%%%%%%%%%%%%%%%

\chapter*{Preface}

This manual applies to XCSoar version 6.0.  The authors reserve the
right to update this manual as enhancements are made throughout the
life of this product.

\section*{Warnings and precautions}

\warning IT IS THE USER'S RESPONSIBILITY TO USE THIS SOFTWARE PRUDENTLY. THIS
SOFTWARE IS INTENDED TO BE USED ONLY AS A NAVIGATION AID AND MUST NOT
BE USED FOR ANY PURPOSE REQUIRING PRECISE MEASUREMENT OF DIRECTION,
DISTANCE, LOCATION, OR TOPOGRAPHY. THIS SOFTWARE SHOULD NOT BE USED AS
AN AID TO DETERMINE GROUND PROXIMITY FOR AIRCRAFT NAVIGATION.
THIS SOFTWARE SHOULD NOT BE USED AS A TRAFFIC COLLISION AVOIDANCE SYSTEM.


\section*{Legal notices}

\subsection*{Software license agreement}

This software is released according to the GNU General Public License
Version~2.  See Appendix~\ref{cha:gnu-general-public} for the full
text of the agreement and warranty notice.

\subsection*{Limited liability}

In no event shall XCSoar, or its principals, shareholders, officers,
employees, affiliates, contractors, subsidiaries, or parent
organizations, be liable for any incidental, consequential, or
punitive damages whatsoever relating to the use of the Product.

\subsection*{Disclaimer}

This product, and all accompanying files, data and materials, are
distributed "as is" and with no warranties of any kind, whether
express or implied.  This product is used entirely at the risk of the
user.  Although great care has been taken to eliminate defects during
its development it is not claimed to be fault-free. No claims are made
regarding its correctness, reliability or fitness for any particular
purpose.  The XCSoar project developers and contributors shall not be
liable for errors contained herein or for incidental or consequential
damages, loss of data or personal injury in connection with
furnishing, performance, or use of this material.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\chapter{Introduction}\label{cha:introduction}

\chapter{Policy}\label{cha:policy}

\section{Writing Patches}

Submit patches or \texttt{git pull} requests to the developer mailing
list (\texttt{xcsoar-devel@lists.sourceforge.net}).  We provide
accounts on \texttt{git.xcsoar.org} to regular contributors.

A patch should be self-explanatory, it needs a good description.  The
subject line specifies the subsystem/library name and a brief
description of what is changed, followed by an empty line.  Then write
a longer description if needed, and explain why this change is needed.

Each patch must compile and must not introduce a regression (as far as
we know at the time).

Each patch must be self-contained and should only change one thing.
Split larger patches into smaller pieces.  Don't refactor and
add/modify/remove features in the same patch.

Don't rewrite code unless you need to.  Migrate incrementally to a new
concept.  Keep patches small and easy to understand.

\section{Code Style}

79 columns, reasonable exceptions allowed.  Indent 2 spaces, no tabs.

\emph{Comments:} write enough code comments (in English).  All
workarounds must be documented.  Everybody must be able to understand
your code, even when you're gone.

\emph{API documentation:} non-trivial functions should be documented
in a doxygen comment.

\emph{Names:} class/function names in \texttt{CamelCase} (not
\texttt{camelCase}); attributes/variables lower case, separated with
underscore (e.g. \texttt{foo\_bar}); constants (including
\texttt{enum} values) all upper case (e.g. \texttt{FOO\_BAR}).

\emph{Files:} \texttt{*.cpp} and \texttt{*.hpp} for C++.  Files should
be named after the main class which is provided.  Each class should
have a separate source file and a separate header.  UNIX text format.

Be \texttt{const}-correct.

Compile with \texttt{WERROR=y} and fix all warnings.

Don't write large functions.  Split them up when they become too
large.

Avoid dynamic allocation.  Dynamic allocation means overhead, more
locking and heap fragmentation.  Use \texttt{StaticArray} and
\texttt{StaticString} if possible.

Asterisks belong to the variable name, not to the type name.  Consider
``\texttt{Foo* a, b}''.  ``\texttt{Foo *a, b}'' or ``\texttt{Foo *a,
  *b}'' is easier to understand.

Some sample code to demonstrate our code style:

\begin{verbatim}
struct TheStruct {
  unsigned an_attribute;
  bool second_attribute;

  TheStruct();

  void TheMethod();
};

TheStruct::TheStruct()
  :an_attribute(0),
   second_attribute(true)
{
}

static bool
FooBar(int a_parameter, unsigned another_parameter,
       const TheStruct *next_row)
{
  switch (a_parameter) {
  case 0:
    break;
  }

  if (a_parameter == 2 && another_parameter == 3 &&
      next_row != NULL)
    return true;

  return a_parameter == 42;
}
\end{verbatim}

\section{C++}

In a class declaration, attributes come first, then
constructor/destructor, and finally the methods.  Having all
attributes in one place gives a good overview of the nature of a
class.

Don't use RTTI and exceptions.

Avoid expensive and bloated STL containers if there are cheaper
solutions (e.g. \texttt{StaticArray}, \texttt{StaticString} if the
maximum size is predictable).

Avoid template hell.  Keep templates readable.  Keep in mind that
excessive template use may bloat the binary.

\section{Graphical User Interface}
\subsection{Letter Cases}

Following the guidline should prevent the GUI from mixtures of "ON" and "On" text elements, and lead to a systematic GUI text presentation. The goal is to recognize GUI text fast and reliable.

\begin{description}
  \item[Captions] Captions (button captions, windows titles) to use
        capitalization. E.g. ,"Pan On", "The Display Of ...". 

  \item[Abbreviations] Generally known abbreviation use upper case like "MC", "ETA",
        "V"; or they can use CamelCase, especially when using synthetic
        words  like "GoTo", "InfoBox". 
        Abbreviated words by simply cutting the end of the word needs a
        dot, e.g. "Max. temp."

  \item[Plain text] Longer help texts are to write like prose: "This is the help
        page for ...".

  \item[Labels] Label text has the least systematic constraints:
\begin{itemize}
    \item Captions for text (input) fields, e.g. "Wing loading"
    \item Info text on widgets. E.g. "No data" on an empty
          analysis page. 
    \item Label text for radio or check boxes. 
    \item Selections on Combo-boxes, selectors, Pull-down menus. 
\end{itemize}
  All those should go like prose, whereas exceptions might be
  meaningful.
  
  \item[Gauge caption] Also the appearance of the gauge caption should be covered with
        that. They are currently mapped to upper case all over. I think
        the most readable also here is a CamelCase approach. E.g. to
        distinct "WP Dist", "WP AltD", and "WP AltR". Another good
        example would be MACCREADY, which should be MacCready, or just
        MC.

  \item[Units] Units have their own specific appearance. A profound paper is
        http://physics.nist.gov/cuu/pdf/checklist.pdf we could just
        refer to.
\end{description}


\chapter{Topology and Terrain}\label{cha:topology}
\section{Topology layer description file}
Each line of the topology layer description file (topology.tpl) contains
a comma seperated list (CSV) of information needed for rendering of an
individual topology layer. Lines starting with '*' are ignored.
\begin{table}[ht]
\centering
\sffamily
\begin{tabular}{@{}lll@{}}
\toprule
\addlinespace
Column name&Data type&Valid range\\
%\midrule
\cmidrule(r){1-1}\cmidrule(lr){2-2}\cmidrule(l){3-3}
filename&string&\\
range&double&-\\
icon&-&-\\
label index&-&-\\
color (red component)&int&0-255\\
color (green component)&int&0-255\\
color (blue component)&int&0-255\\
pen width&int&0-31\\
label range&double&-\\
important label range&double&-\\
%\addlinespace
\bottomrule
\end{tabular}
\caption{Topology file format}
\label{tab:topology-file-format}
\end{table}

\begin{description}
\item[filename] The filename of the topology layer within the container file.
\item[range] A threshold zoom level. All layer elements will not be drawn
below this threshold.
\item[pen width] Lines containded within this layer are drawn with pen width.
\item[label range] A threshold zoom level. Labels contained in the layer file
will not be rendered below this threshold.
will not be drawn.
\item[important label range] A threshold zoom level. Labels contained
in the layer file will be rendered in standard style below this threshold.
\end{description}

\chapter{Architecture}

This chapter describes XCSoar's internal code architecture.

\section{Threads and Locking}

\subsection{Threads}

XCSoar runs on multiple threads, to make the UI responsive but still
allow expensive background calculations.

This is how it looks like on Windows and Linux/SDL (software
rendering):

\begin{tikzpicture}
  \node(ui)[thread]{UI thread};

  \path(ui.east)+(4,0) node(draw)[thread]{DrawThread};
  \draw[->] (ui.10) -- (draw.170)
  node[midway, above, sloped, font=\tiny]{redraw (Pan)};
  \draw[->] (draw.190) -- (ui.350)
  node[midway, below, sloped, font=\tiny]{BufferCanvas};

  \path(draw.south)+(0,-2) node(calc)[thread]{CalcThread};
  \draw[->] (calc.north) -- (draw.south)
  node[midway, below, sloped, font=\tiny]{results};

  \path(calc.south)+(-3,-2) node(device1)[thread]{Device};
  \draw[->] (device1.north) -- (calc.250)
  node[midway, above, sloped, font=\tiny]{sensor data};

  \path(calc.south)+(3,-2) node(device2)[thread]{Device 2};
  \draw[->] (device2.north) -- (calc.290)
  node[midway, above, sloped, font=\tiny]{sensor data};
\end{tikzpicture}

The UI thread is the main thread.  It starts the other threads and is
responsible for the UI event loop.  No other thread is allowed to
manipulate windows.  The UI thread has a timer which does regular
house keeping twice per second (\texttt{Pro\-cess\-Ti\-mer.cpp}).

The calculation thread (\texttt{Calcu\-la\-tion\-Thread.cpp},
\texttt{Glide\-Com\-pu\-ter*.cpp}) does all the expensive calculations in
background.  It gets data from the devices and forwards it together
with calculation results to the drawing thread and the main thread.

Each device has its own thread (\texttt{Serial\-Port.cpp}).  This is
needed because Windows CE does not support asynchronous COMM port I/O.
The thread is stopped during task declaration (which happens in the UI
thread).

With OpenGL, the map is rendered live without a buffer.  There is no
DrawThread.

On Android, the UI thread is not the main thread - the main thread is
implemented in Java, managed by Android itself.  The UI thread listens
for events which the Java part drops into the event queue
(\texttt{NativeView.java} and others).  The internal GPS does not need
a thread, it is implemented with Java callbacks.  For Bluetooth I/O,
there are two threads implemented in Java (\texttt{InputThread.java}
and \texttt{OutputThread.java}, managed by
\texttt{BluetoothHelper.java}).

\subsection{Locking}

Some data structures are rarely modified.  There is no lock for them.
For a modifications, all threads must be suspended.  Example:
waypoints, airspaces.

Other data structures are modified so often that correct locking would
be too much overhead.  Each thread and each instance has its own
copy.  The lock needs to be obtained only for making the private
copy.  The private copy can be used without locking.  Example:
\texttt{NMEA\_INFO}, \texttt{DERIVED\_INFO}.

There are objects which are too expensive to copy.  Normal locking
applies to them.  We have a template class called \texttt{Guard} to
enforce proper read/write locking.  Example: the task.

\appendix

\chapter{GNU General Public License}\label{cha:gnu-general-public}
\input{../shared/gpl.tex}

\end{document}
